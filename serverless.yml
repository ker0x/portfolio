service: portfolio

useDotenv: false
variablesResolutionMode: 20210326

provider:
  name: aws
  region: eu-west-3
  runtime: provided.al2
  lambdaHashingVersion: 20201221
  environment:
    APP_ENV: prod

plugins:
  - ./vendor/bref/bref

functions:
  website:
    handler: public/index.php
    description: ''
    timeout: 28 # in seconds (API Gateway has a timeout of 29 seconds)
    layers:
      - ${bref:layer.php-80-fpm}
    events:
      - http: 'ANY /'
      - http: 'ANY /{proxy+}'
        
  console:
    handler: bin/console
    description: ''
    timeout: 120
    layers:
      - ${bref:layer.php-80} # PHP
      - ${bref:layer.console} # The "console" layer
        
resources:
  Resources:
    # The S3 bucket that stores the assets
    Assets:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: portfolio-dev-eu-west-3-6rwlxnj8r9

    # The policy that makes the bucket publicly readable
    AssetsBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref Assets # References the bucket we defined above
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal: '*' # everyone
              Action: 's3:GetObject' # to read
              Resource: !Join [ '/', [ !GetAtt Assets.Arn, '*' ] ] # things in the bucket
              # alternatively you can write out Resource: 'arn:aws:s3:::<bucket-name>/*'
    

# Specify the directories and files which should be included or excluded in the deployment package
package:
  patterns:
    # Include
    - 'var/cache/prod/**'
    # Exclude
    - '!assets/**'
    - '!node_modules/**'
    - '!public/build/**'
    - '!tests/**'
    - '!var/**'
